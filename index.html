<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js"></script>
<script src="https://tonejs.github.io/build/Tone.js"></script>
<button id="startBtn">start</button>
<script>
/* global nn, Tone */

const state = {
  step: 0,
  melodyStep: 0,
  cycles: 0, // Added to track the cycles of bass notes and chords
  notes: ['G2', ['B3', 'F#4', 'D4'], 'D2', ['A3', 'C#4', 'F#4']],
  melody: ['F#5', 'C#5', 'C#5', 'C#5', 'C#5', 'C#5', 'B4', 'C#5', 'B4'], // Example melody notes
};

const synth = new Tone.PolySynth(Tone.Synth).toDestination(); // Use PolySynth for chords
synth.set({ oscillator: { type: 'sine' }});

const melodySynth = new Tone.Synth().toDestination(); // Separate synth for melody
melodySynth.oscillator.type = 'sine';

function playChordAndBass(time) {
  const current = state.notes[state.step % state.notes.length];
  
  if (Array.isArray(current)) {
    synth.triggerAttackRelease(current, '2n', time);
  } else {
    synth.triggerAttackRelease(current, '2n', time);
  }
  
  // Increment step and check if we've completed a cycle through the notes
  state.step++;
  if (state.step % state.notes.length === 0) {
    state.cycles++; // Increment cycles after each complete pass through the notes
  }
  
  // Check if two cycles of bass notes have been completed to start melody
  if (state.cycles === 2 && state.step % state.notes.length === 0) {
    Tone.Transport.scheduleRepeat(playMelody, '8n', time); // Schedule melody with its own repeat
  }
}

function playMelody(time) {
  if(state.melodyStep < state.melody.length) { // Check if there are more melody notes to play
    const note = state.melody[state.melodyStep++];
    melodySynth.triggerAttackRelease(note, '16n', time);
  } else {
    Tone.Transport.clear(playMelody); // Stop the melody once all notes have been played
  }
}

function toggle() {
  if (Tone.Transport.state === 'started') {
    Tone.Transport.stop();
    document.getElementById('startBtn').innerText = 'start';
  } else {
    Tone.Transport.start();
    document.getElementById('startBtn').innerText = 'stop';
  }
}

function setup() {
  state.step = 0;
  state.melodyStep = 0;
  state.cycles = 0; // Reset cycles
  console.log('Setup complete, ready to play.');
}

document.getElementById('startBtn').addEventListener('click', toggle);

Tone.Transport.bpm.value = 100;
Tone.Transport.scheduleRepeat(playChordAndBass, '2n'); // This will play chords and bass notes

window.addEventListener('load', setup);
</script>
